<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANDIT - AprilTag Detection System</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            padding: 24px 32px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .brand-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: #1e293b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #ffffff;
            font-size: 18px;
        }
        
        .brand-info h1 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 2px;
        }
        
        .company-name {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }
        
        .header-meta {
            text-align: right;
        }
        
        .version {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            background: #f8fafc;
        }
        
        .video-section {
            padding: 32px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
        }
        
        .video-container {
            position: relative;
            background: #000000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }
        
        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
            max-width: 100%;
        }
        
        .video-overlay {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.75);
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: 'Inter', monospace;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #1e293b;
            color: #ffffff;
            border: 1px solid #334155;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.primary {
            background: #3b82f6;
            border-color: #2563eb;
        }
        
        .btn.primary:hover {
            background: #2563eb;
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .status.connected {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status.disconnected {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .sidebar {
            background: #f8fafc;
            padding: 32px 24px;
            overflow-y: auto;
        }
        
        .info-panel {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .info-panel h3 {
            margin: 0 0 16px 0;
            color: #0f172a;
            font-size: 16px;
            font-weight: 600;
        }
        
        .tag-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tag-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .tag-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .tag-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .tag-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .tag-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }
        
        .tag-id {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .tag-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
            color: #64748b;
        }
        
        .tag-info span {
            display: block;
            margin-bottom: 4px;
        }
        
        .tag-info strong {
            color: #374151;
            font-weight: 500;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .stat-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            display: block;
            font-family: 'Inter', monospace;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .coordinates {
            font-family: 'Inter', monospace;
            font-size: 12px;
            background: #f1f5f9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            border: 1px solid #e2e8f0;
            color: #475569;
        }
        
        .collapsible-panel {
            margin-bottom: 24px;
        }
        
        .panel-header {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px 8px 0 0;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease;
        }
        
        .panel-header:hover {
            background: #e2e8f0;
        }
        
        .panel-header.collapsed {
            border-radius: 8px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .panel-chevron {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            color: #64748b;
        }
        
        .panel-chevron.expanded {
            transform: rotate(180deg);
        }
        
        .panel-content {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 16px;
            display: none;
        }
        
        .panel-content.expanded {
            display: block;
        }
        
        .camera-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .camera-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .camera-item:hover {
            background: #f1f5f9;
        }
        
        .camera-item.active {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .camera-info {
            flex: 1;
        }
        
        .camera-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 14px;
        }
        
        .camera-details {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .camera-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .current-badge {
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .video-section {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .video-section {
                padding: 20px;
            }
            
            .sidebar {
                padding: 20px 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="brand-section">
                    <div class="logo">B</div>
                    <div class="brand-info">
                        <h1>BANDIT</h1>
                        <div class="company-name">Dark Matter Labs</div>
                    </div>
                </div>
                <div class="header-meta">
                    <div class="version">Version 2.1.0</div>
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        System Operational
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="videoFeed" src="/video_feed" alt="Video Feed">
                    <div class="video-overlay">
                        <span id="fps">FPS: --</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn primary" onclick="startDetection()">Start Detection</button>
                    <button class="btn" onclick="stopDetection()">Stop Detection</button>
                    <button class="btn" onclick="calibrateCamera()">Calibrate Camera</button>
                    <div class="status" id="connectionStatus">Connecting...</div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="collapsible-panel">
                    <div class="panel-header collapsed" onclick="togglePanel('cameraOptions')">
                        <span class="panel-title">Camera Options</span>
                        <svg class="panel-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="panel-content" id="cameraOptions">
                        <div class="camera-list" id="cameraList">
                            <div style="text-align: center; color: #64748b; padding: 20px;">
                                Loading cameras...
                            </div>
                        </div>
                        <button class="btn btn-small" onclick="refreshCameras()" style="margin-top: 12px; width: 100%;">
                            Refresh Camera List
                        </button>
                    </div>
                </div>
                
                <div class="info-panel">
                    <h3>Detection Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value" id="tagCount">0</span>
                            <div class="stat-label">Tags Detected</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="avgDistance">--</span>
                            <div class="stat-label">Avg Distance (m)</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-panel">
                    <h3>Detected Tags</h3>
                    <div class="tag-list" id="tagList">
                        <p style="text-align: center; color: #64748b; margin: 20px 0;">No tags detected</p>
                    </div>
                </div>
                
                <div class="info-panel">
                    <h3>System Configuration</h3>
                    <div style="font-size: 13px; color: #64748b; line-height: 1.5;">
                        <p><strong style="color: #374151;">Camera Resolution:</strong> <span id="cameraInfo">640×480</span></p>
                        <p><strong style="color: #374151;">Detection Families:</strong> tag36h11, tag25h9</p>
                        <p><strong style="color: #374151;">Tag Size:</strong> 6.0" × 6.0"</p>
                        <p><strong style="color: #374151;">Pose Algorithm:</strong> PnP + Rodrigues</p>
                        <p><strong style="color: #374151;">Coordinate System:</strong> Right-handed (X, Y, Z)</p>
                        <p><strong style="color: #374151;">Measurement Units:</strong> Meters, Degrees, PPI</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isDetecting = false;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();

        // Socket event handlers
        socket.on('connect', function() {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'status connected';
        });

        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'status disconnected';
        });

        socket.on('frame_data', function(data) {
            if (data.image) {
                updateVideoFeed(data.image);
            }
            if (data.tags) {
                updateTagInfo(data.tags);
            }
            updateFPS();
        });

        socket.on('calibration_result', function(data) {
            if (data.success) {
                showNotification('Success', data.message, 'success');
                if (data.calibration_data) {
                    console.log('Calibration saved:', data.calibration_data);
                    // Update UI to show calibration is complete
                    updateCalibrationStatus(data.calibration_data);
                }
            } else {
                showNotification('Calibration Failed', data.message, 'error');
            }
        });

        socket.on('camera_switch_result', function(data) {
            if (data.success) {
                showNotification('Camera Switched', data.message, 'success');
                // Refresh camera list to update current camera
                loadCameras();
            } else {
                showNotification('Camera Switch Failed', data.message, 'error');
            }
        });

        function updateVideoFeed(imageData) {
            // The video feed is handled by the /video_feed route
            // This function could be used for WebSocket-based streaming if needed
        }

        function updateTagInfo(tags) {
            const tagCount = document.getElementById('tagCount');
            const tagList = document.getElementById('tagList');
            const avgDistance = document.getElementById('avgDistance');

            tagCount.textContent = tags.length;

            if (tags.length === 0) {
                tagList.innerHTML = '<p style="text-align: center; color: #b8c6db; margin: 20px 0;">No tags detected</p>';
                avgDistance.textContent = '--';
                return;
            }

            // Calculate average distance
            const totalDistance = tags.reduce((sum, tag) => sum + tag.distance, 0);
            const average = totalDistance / tags.length;
            avgDistance.textContent = average.toFixed(3);

            // Update tag list
            tagList.innerHTML = '';
            tags.forEach(tag => {
                const tagElement = createTagElement(tag);
                tagList.appendChild(tagElement);
            });
        }

        function createTagElement(tag) {
            const div = document.createElement('div');
            div.className = 'tag-item';
            
            const euler = tag.pose.euler_angles;
            const translation = tag.pose.translation;
            
            div.innerHTML = `
                <div class="tag-id">Tag ID: ${tag.id} (${tag.family})</div>
                <div class="tag-info">
                    <span><strong>Family:</strong> ${tag.family}</span>
                    <span><strong>Distance:</strong> ${tag.distance.toFixed(3)}m</span>
                    <span><strong>Center:</strong> (${Math.round(tag.center[0])}, ${Math.round(tag.center[1])})</span>
                    <span><strong>Roll:</strong> ${euler[0].toFixed(1)}°</span>
                    <span><strong>Pitch:</strong> ${euler[1].toFixed(1)}°</span>
                    <span><strong>Yaw:</strong> ${euler[2].toFixed(1)}°</span>
                    <span><strong>X:</strong> ${translation[0].toFixed(3)}m</span>
                    <span><strong>Y:</strong> ${translation[1].toFixed(3)}m</span>
                    <span><strong>Z:</strong> ${translation[2].toFixed(3)}m</span>
                    <span><strong>PPI:</strong> ${tag.pixels_per_inch.average.toFixed(1)}</span>
                    <span><strong>Tag Size:</strong> ${Math.round(tag.pixels_per_inch.tag_width_pixels)}×${Math.round(tag.pixels_per_inch.tag_height_pixels)}px</span>
                </div>
                <div class="coordinates">
                    Position: [${translation.map(v => v.toFixed(3)).join(', ')}]<br>
                    Rotation: [${euler.map(v => v.toFixed(1)).join(', ')}]°<br>
                    PPI: W=${tag.pixels_per_inch.width.toFixed(1)}, H=${tag.pixels_per_inch.height.toFixed(1)}
                </div>
            `;
            
            return div;
        }

        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                const fps = Math.round(frameCount * 1000 / (now - lastFpsUpdate));
                document.getElementById('fps').textContent = `FPS: ${fps}`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        function startDetection() {
            isDetecting = true;
            // The detection is continuous via the video feed
            console.log('Detection started');
        }

        function stopDetection() {
            isDetecting = false;
            console.log('Detection stopped');
        }

        function calibrateCamera() {
            // Disable the button during calibration
            const calibrateBtn = document.querySelector('button[onclick="calibrateCamera()"]');
            const originalText = calibrateBtn.textContent;
            calibrateBtn.disabled = true;
            calibrateBtn.textContent = 'Calibrating...';
            
            // Send calibration request
            socket.emit('calibrate_camera');
            
            // Re-enable button after a delay
            setTimeout(() => {
                calibrateBtn.disabled = false;
                calibrateBtn.textContent = originalText;
            }, 3000);
        }

        function showNotification(title, message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                max-width: 400px;
                z-index: 1000;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                background: ${type === 'success' ? '#22c55e' : '#ef4444'};
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
                <div style="font-size: 14px; opacity: 0.9;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function updateCalibrationStatus(calibrationData) {
            // Update system info to show current calibration
            const systemInfo = document.querySelector('.info-panel:last-child div');
            const ppiInfo = document.createElement('p');
            ppiInfo.innerHTML = `<strong style="color: #374151;">Current Calibration:</strong> ${calibrationData.pixels_per_inch.toFixed(2)} PPI (${calibrationData.tags_used} tags)`;
            ppiInfo.style.color = '#22c55e';
            ppiInfo.style.fontWeight = '500';
            systemInfo.appendChild(ppiInfo);
        }

        // Load current calibration on page load
        function loadCurrentCalibration() {
            fetch('/api/calibration')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateCalibrationStatus({
                            pixels_per_inch: data.calibration.calibrated_pixels_per_inch,
                            tags_used: data.calibration.tags_used
                        });
                    }
                })
                .catch(error => console.log('No previous calibration found'));
        }

        // Panel toggle functionality
        function togglePanel(panelId) {
            const header = document.querySelector(`[onclick="togglePanel('${panelId}')"]`);
            const content = document.getElementById(panelId);
            const chevron = header.querySelector('.panel-chevron');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.add('collapsed');
                chevron.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.remove('collapsed');
                chevron.classList.add('expanded');
                
                // Load cameras when opening panel
                if (panelId === 'cameraOptions') {
                    loadCameras();
                }
            }
        }

        // Load available cameras
        function loadCameras() {
            fetch('/api/cameras')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCameras(data.cameras, data.current_camera);
                    } else {
                        document.getElementById('cameraList').innerHTML = 
                            '<div style="text-align: center; color: #ef4444; padding: 20px;">Failed to load cameras</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                    document.getElementById('cameraList').innerHTML = 
                        '<div style="text-align: center; color: #ef4444; padding: 20px;">Error loading cameras</div>';
                });
        }

        // Display camera list
        function displayCameras(cameras, currentCamera) {
            const cameraList = document.getElementById('cameraList');
            
            if (cameras.length === 0) {
                cameraList.innerHTML = 
                    '<div style="text-align: center; color: #64748b; padding: 20px;">No cameras found</div>';
                return;
            }
            
            cameraList.innerHTML = '';
            
            cameras.forEach(camera => {
                const cameraItem = document.createElement('div');
                cameraItem.className = `camera-item ${camera.is_current ? 'active' : ''}`;
                
                cameraItem.innerHTML = `
                    <div class="camera-info">
                        <div class="camera-name">
                            ${camera.name}
                            ${camera.is_current ? '<span class="current-badge">Current</span>' : ''}
                        </div>
                        <div class="camera-details">${camera.resolution} • ${camera.fps} FPS</div>
                    </div>
                    <div class="camera-actions">
                        ${!camera.is_current ? `<button class="btn btn-small primary" onclick="switchCamera(${camera.index})">Switch</button>` : ''}
                    </div>
                `;
                
                cameraList.appendChild(cameraItem);
            });
        }

        // Switch camera
        function switchCamera(cameraIndex) {
            socket.emit('switch_camera', { camera_index: cameraIndex });
        }

        // Refresh camera list
        function refreshCameras() {
            const refreshBtn = document.querySelector('button[onclick="refreshCameras()"]');
            const originalText = refreshBtn.textContent;
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Refreshing...';
            
            loadCameras();
            
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
            }, 2000);
        }

        // Auto-refresh tag data
        setInterval(() => {
            if (isDetecting) {
                socket.emit('get_frame');
            }
        }, 100); // 10 FPS for tag data updates

        // Start detection automatically and load calibration
        window.addEventListener('load', () => {
            setTimeout(startDetection, 1000);
            loadCurrentCalibration();
        });
    </script>
</body>
</html>